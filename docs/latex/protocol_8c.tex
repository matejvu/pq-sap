\doxysection{src/protocol.c File Reference}
\hypertarget{protocol_8c}{}\label{protocol_8c}\index{src/protocol.c@{src/protocol.c}}
{\ttfamily \#include "{}protocol\+\_\+api.\+h"{}}\newline
Include dependency graph for protocol.\+c\+:
% FIG 0
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{protocol_8c_ac42ee8dc097e52d63dd4e8371d769d12}{STEALTH\+\_\+\+ADDRESS\+\_\+\+BYTES}}~(\mbox{\hyperlink{params_8h_a1e66e19d25aceeae49d1184a077f92db}{KYBER\+\_\+K}} \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{params_8h_af66bcd4f5c1ee3377ed637b38ed8f356}{KYBER\+\_\+\+POLYBYTES}})
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{protocol_8c_a858f8d44b117050df006c629482959fc}{recipient\+\_\+computes\+\_\+stealth\+\_\+pub\+\_\+key}} (uint8\+\_\+t stealth\+\_\+pub\+\_\+key\mbox{[}(\mbox{\hyperlink{params_8h_a1e66e19d25aceeae49d1184a077f92db}{KYBER\+\_\+K}} \texorpdfstring{$\ast$}{*}\mbox{\hyperlink{params_8h_af66bcd4f5c1ee3377ed637b38ed8f356}{KYBER\+\_\+\+POLYBYTES}})\mbox{]}, const uint8\+\_\+t k\+\_\+pub\mbox{[}\mbox{\hyperlink{params_8h_a7663b32715a32f12eb70420793753ce3}{KYBER\+\_\+\+PUBLICKEYBYTES}}\mbox{]}, const uint8\+\_\+t ephemeral\+\_\+pub\+\_\+key\mbox{[}\mbox{\hyperlink{params_8h_a356cca49fc302b0c34c18f4bbda6e5fe}{KYBER\+\_\+\+CIPHERTEXTBYTES}}\mbox{]}, const uint8\+\_\+t v\mbox{[}\mbox{\hyperlink{params_8h_a7f9a2f9ae6937442f988816af97babb3}{KYBER\+\_\+\+SECRETKEYBYTES}}\mbox{]})
\begin{DoxyCompactList}\small\item\em Workflow\+: \end{DoxyCompactList}\item 
void \mbox{\hyperlink{protocol_8c_a741d56808420f6e2ee9e851f4122dae0}{sender\+\_\+computes\+\_\+stealth\+\_\+pub\+\_\+key\+\_\+and\+\_\+viewtag}} (uint8\+\_\+t stealth\+\_\+pub\+\_\+key\mbox{[}(\mbox{\hyperlink{params_8h_a1e66e19d25aceeae49d1184a077f92db}{KYBER\+\_\+K}} \texorpdfstring{$\ast$}{*}\mbox{\hyperlink{params_8h_af66bcd4f5c1ee3377ed637b38ed8f356}{KYBER\+\_\+\+POLYBYTES}})\mbox{]}, uint8\+\_\+t ephemeral\+\_\+pub\+\_\+key\mbox{[}\mbox{\hyperlink{params_8h_a356cca49fc302b0c34c18f4bbda6e5fe}{KYBER\+\_\+\+CIPHERTEXTBYTES}}\mbox{]}, uint8\+\_\+t \texorpdfstring{$\ast$}{*}view\+\_\+tag, const uint8\+\_\+t v\+\_\+pub\mbox{[}\mbox{\hyperlink{params_8h_a7663b32715a32f12eb70420793753ce3}{KYBER\+\_\+\+PUBLICKEYBYTES}}\mbox{]}, const uint8\+\_\+t k\+\_\+pub\mbox{[}\mbox{\hyperlink{params_8h_a7663b32715a32f12eb70420793753ce3}{KYBER\+\_\+\+PUBLICKEYBYTES}}\mbox{]})
\begin{DoxyCompactList}\small\item\em Workflow\+: \end{DoxyCompactList}\item 
uint8\+\_\+t \mbox{\hyperlink{protocol_8c_a9a43976b56c90c6d13ef53bda55a3d34}{calculate\+\_\+view\+\_\+tag}} (const uint8\+\_\+t ss\mbox{[}\mbox{\hyperlink{params_8h_a5054c9269277412d8536eb82cfffbe15}{KYBER\+\_\+\+SSBYTES}}\mbox{]})
\begin{DoxyCompactList}\small\item\em Workflow\+: \end{DoxyCompactList}\item 
void \mbox{\hyperlink{protocol_8c_a2a804d61df9a40fc309e6c609739110d}{calculate\+\_\+stealth\+\_\+pub\+\_\+key}} (uint8\+\_\+t stealth\+\_\+pub\+\_\+key\mbox{[}(\mbox{\hyperlink{params_8h_a1e66e19d25aceeae49d1184a077f92db}{KYBER\+\_\+K}} \texorpdfstring{$\ast$}{*}\mbox{\hyperlink{params_8h_af66bcd4f5c1ee3377ed637b38ed8f356}{KYBER\+\_\+\+POLYBYTES}})\mbox{]}, const uint8\+\_\+t ss\mbox{[}\mbox{\hyperlink{params_8h_a132bbc78e88ea5e14e93e0963dd5d0f9}{KYBER\+\_\+\+SYMBYTES}}\mbox{]}, const uint8\+\_\+t k\+\_\+pub\mbox{[}\mbox{\hyperlink{params_8h_a4c9f2345946a0d01dc2051b493c2bda4}{KYBER\+\_\+\+INDCPA\+\_\+\+PUBLICKEYBYTES}}\mbox{]})
\begin{DoxyCompactList}\small\item\em Workflow\+: \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Macro Definition Documentation}
\Hypertarget{protocol_8c_ac42ee8dc097e52d63dd4e8371d769d12}\label{protocol_8c_ac42ee8dc097e52d63dd4e8371d769d12} 
\index{protocol.c@{protocol.c}!STEALTH\_ADDRESS\_BYTES@{STEALTH\_ADDRESS\_BYTES}}
\index{STEALTH\_ADDRESS\_BYTES@{STEALTH\_ADDRESS\_BYTES}!protocol.c@{protocol.c}}
\doxysubsubsection{\texorpdfstring{STEALTH\_ADDRESS\_BYTES}{STEALTH\_ADDRESS\_BYTES}}
{\footnotesize\ttfamily \#define STEALTH\+\_\+\+ADDRESS\+\_\+\+BYTES~(\mbox{\hyperlink{params_8h_a1e66e19d25aceeae49d1184a077f92db}{KYBER\+\_\+K}} \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{params_8h_af66bcd4f5c1ee3377ed637b38ed8f356}{KYBER\+\_\+\+POLYBYTES}})}



\doxysubsection{Function Documentation}
\Hypertarget{protocol_8c_a2a804d61df9a40fc309e6c609739110d}\label{protocol_8c_a2a804d61df9a40fc309e6c609739110d} 
\index{protocol.c@{protocol.c}!calculate\_stealth\_pub\_key@{calculate\_stealth\_pub\_key}}
\index{calculate\_stealth\_pub\_key@{calculate\_stealth\_pub\_key}!protocol.c@{protocol.c}}
\doxysubsubsection{\texorpdfstring{calculate\_stealth\_pub\_key()}{calculate\_stealth\_pub\_key()}}
{\footnotesize\ttfamily void calculate\+\_\+stealth\+\_\+pub\+\_\+key (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{stealth\+\_\+pub\+\_\+key\mbox{[}(\+KYBER\+\_\+\+K \texorpdfstring{$\ast$}{*}\+KYBER\+\_\+\+POLYBYTES)\mbox{]},  }\item[{const uint8\+\_\+t}]{ss\mbox{[}\+KYBER\+\_\+\+SYMBYTES\mbox{]},  }\item[{const uint8\+\_\+t}]{k\+\_\+pub\mbox{[}\+KYBER\+\_\+\+INDCPA\+\_\+\+PUBLICKEYBYTES\mbox{]} }\end{DoxyParamCaption})}



Workflow\+: 

Calculates the public key of the stealth address.


\begin{DoxyEnumerate}
\item Initializes polyvec structures.
\begin{DoxyItemize}
\item This step initializes the polyvec structures pkpv and skpv. These structures hold polynomial vectors, and each polynomial is essentially a vector of coefficients used in lattice-\/based cryptography.\+The public\+\_\+seed is initialized to zero here, which will later be used to derive the public key.
\end{DoxyItemize}
\item Unpacks recipient\textquotesingle{}s public key using \doxylink{indcpa_8h_a0b1c9afb8ba4870a733d4f675c8028a9}{unpack\+\_\+pk(\&pkpv, public\+\_\+seed, k\+\_\+pub)} .The unpacked public key is stored in {\ttfamily pkpv}.
\item Derives matrix A deterministically using \doxylink{indcpa_8h_a95867e1475dc47314959ced95627df2c}{gen\+\_\+matrix(a, public\+\_\+seed, 0)} .
\begin{DoxyItemize}
\item The \doxylink{indcpa_8h_a95867e1475dc47314959ced95627df2c}{gen\+\_\+matrix()} function fills in the matrix a with polynomials where the coefficients are derived from a cryptographic randomness function \doxylink{symmetric_8h_a6e88e8a31d1cc278f777a453e22d35f5}{xof\+\_\+squeezeblocks()}
\end{DoxyItemize}
\item Converts shared secret into a noise sampled secret key vector {\ttfamily skpv} using \doxylink{poly_8h_a7acff2171f8515dcda521e0abce1f164}{poly\+\_\+getnoise\+\_\+eta1()} .
\item Computes A \texorpdfstring{$\ast$}{*} S + K polynomial vector\+:
\begin{DoxyItemize}
\item Calls \doxylink{polyvec_8h_a5ef9e3b32a6e413955076778ca9f056f}{polyvec\+\_\+basemul\+\_\+acc\+\_\+montgomery()} and \doxylink{poly_8h_a245ca8de277f9a977284c692163f3f93}{poly\+\_\+tomont()} for each element.
\end{DoxyItemize}
\item Adds original public key polynomial and reduces ( \doxylink{polyvec_8h_afeba48290257815f6213f9812426fe8d}{polyvec\+\_\+add(\&p\+\_\+poly, \&p\+\_\+poly, \&pkpv)} \doxylink{polyvec_8h_a0ee7c5915d658a6b2d9e69c62aa35162}{polyvec\+\_\+reduce(\&p\+\_\+poly)} ).
\item Converts resulting polynomial vector into byte array using \doxylink{polyvec_8h_a68bc449baca16c3d14c221146fed8a62}{polyvec\+\_\+tobytes(stealth\+\_\+pub\+\_\+key, \&p\+\_\+poly)}.
\end{DoxyEnumerate}


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em stealth\+\_\+pub\+\_\+key} & Output array for stealth public key. \\
\hline
\mbox{\texttt{ in}}  & {\em ss} & Shared secret. \\
\hline
\mbox{\texttt{ in}}  & {\em k\+\_\+pub} & Recipient\textquotesingle{}s public spending key. \\
\hline
\end{DoxyParams}
\Hypertarget{protocol_8c_a9a43976b56c90c6d13ef53bda55a3d34}\label{protocol_8c_a9a43976b56c90c6d13ef53bda55a3d34} 
\index{protocol.c@{protocol.c}!calculate\_view\_tag@{calculate\_view\_tag}}
\index{calculate\_view\_tag@{calculate\_view\_tag}!protocol.c@{protocol.c}}
\doxysubsubsection{\texorpdfstring{calculate\_view\_tag()}{calculate\_view\_tag()}}
{\footnotesize\ttfamily uint8\+\_\+t calculate\+\_\+view\+\_\+tag (\begin{DoxyParamCaption}\item[{const uint8\+\_\+t}]{ss\mbox{[}\+KYBER\+\_\+\+SSBYTES\mbox{]} }\end{DoxyParamCaption})}



Workflow\+: 

Calculates a view tag from a shared secret.


\begin{DoxyEnumerate}
\item Calls \doxylink{fips202_8h_a503922aece24ae8b03030593676c4ce2}{shake128(hash, 32, ss, KYBER\+\_\+\+SSBYTES)} to hash the shared secret into 32 bytes.
\item Takes the first byte of the hash as the view tag.
\end{DoxyEnumerate}


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em ss} & Shared secret. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
uint8\+\_\+t View tag (single byte). 
\end{DoxyReturn}
\Hypertarget{protocol_8c_a858f8d44b117050df006c629482959fc}\label{protocol_8c_a858f8d44b117050df006c629482959fc} 
\index{protocol.c@{protocol.c}!recipient\_computes\_stealth\_pub\_key@{recipient\_computes\_stealth\_pub\_key}}
\index{recipient\_computes\_stealth\_pub\_key@{recipient\_computes\_stealth\_pub\_key}!protocol.c@{protocol.c}}
\doxysubsubsection{\texorpdfstring{recipient\_computes\_stealth\_pub\_key()}{recipient\_computes\_stealth\_pub\_key()}}
{\footnotesize\ttfamily void recipient\+\_\+computes\+\_\+stealth\+\_\+pub\+\_\+key (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{stealth\+\_\+pub\+\_\+key\mbox{[}(\+KYBER\+\_\+\+K \texorpdfstring{$\ast$}{*}\+KYBER\+\_\+\+POLYBYTES)\mbox{]},  }\item[{const uint8\+\_\+t}]{k\+\_\+pub\mbox{[}\+KYBER\+\_\+\+PUBLICKEYBYTES\mbox{]},  }\item[{const uint8\+\_\+t}]{ephemeral\+\_\+pub\+\_\+key\mbox{[}\+KYBER\+\_\+\+CIPHERTEXTBYTES\mbox{]},  }\item[{const uint8\+\_\+t}]{v\mbox{[}\+KYBER\+\_\+\+SECRETKEYBYTES\mbox{]} }\end{DoxyParamCaption})}



Workflow\+: 

Computes the stealth public key by the recipient.


\begin{DoxyEnumerate}
\item Calls \doxylink{kem_8h_a08dbb674e5d520aca994bc4472ce5a02}{crypto\+\_\+kem\+\_\+dec(ss, ephemeral\+\_\+pub\+\_\+key, v)} to derive shared secret {\ttfamily ss} from ephemeral public key and private key {\ttfamily v}.
\item Prints recipient\textquotesingle{}s public key and derived shared secret.
\item Calls \doxylink{protocol__api_8h_a2a804d61df9a40fc309e6c609739110d}{calculate\+\_\+stealth\+\_\+pub\+\_\+key()} to compute stealth public key using public key {\ttfamily k\+\_\+pub} and shared secret {\ttfamily ss}. The resulting stealth public key is written into the output parameter {\ttfamily stealth\+\_\+pub\+\_\+key}.
\end{DoxyEnumerate}


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em stealth\+\_\+pub\+\_\+key} & Output array for the computed stealth public key. \\
\hline
\mbox{\texttt{ in}}  & {\em k\+\_\+pub} & Recipient\textquotesingle{}s public spending key. \\
\hline
\mbox{\texttt{ in}}  & {\em ephemeral\+\_\+pub\+\_\+key} & Ephemeral public key received from the sender. \\
\hline
\mbox{\texttt{ in}}  & {\em v} & Recipient\textquotesingle{}s private "{}view"{} key. \\
\hline
\end{DoxyParams}
\Hypertarget{protocol_8c_a741d56808420f6e2ee9e851f4122dae0}\label{protocol_8c_a741d56808420f6e2ee9e851f4122dae0} 
\index{protocol.c@{protocol.c}!sender\_computes\_stealth\_pub\_key\_and\_viewtag@{sender\_computes\_stealth\_pub\_key\_and\_viewtag}}
\index{sender\_computes\_stealth\_pub\_key\_and\_viewtag@{sender\_computes\_stealth\_pub\_key\_and\_viewtag}!protocol.c@{protocol.c}}
\doxysubsubsection{\texorpdfstring{sender\_computes\_stealth\_pub\_key\_and\_viewtag()}{sender\_computes\_stealth\_pub\_key\_and\_viewtag()}}
{\footnotesize\ttfamily void sender\+\_\+computes\+\_\+stealth\+\_\+pub\+\_\+key\+\_\+and\+\_\+viewtag (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{stealth\+\_\+pub\+\_\+key\mbox{[}(\+KYBER\+\_\+\+K \texorpdfstring{$\ast$}{*}\+KYBER\+\_\+\+POLYBYTES)\mbox{]},  }\item[{uint8\+\_\+t}]{ephemeral\+\_\+pub\+\_\+key\mbox{[}\+KYBER\+\_\+\+CIPHERTEXTBYTES\mbox{]},  }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{view\+\_\+tag,  }\item[{const uint8\+\_\+t}]{v\+\_\+pub\mbox{[}\+KYBER\+\_\+\+PUBLICKEYBYTES\mbox{]},  }\item[{const uint8\+\_\+t}]{k\+\_\+pub\mbox{[}\+KYBER\+\_\+\+PUBLICKEYBYTES\mbox{]} }\end{DoxyParamCaption})}



Workflow\+: 

Computes the stealth public key and view tag by the sender.


\begin{DoxyEnumerate}
\item Validates input.
\item Calls \doxylink{kem_8h_a34799e9bffdfd9786a5fcd8867837c74}{crypto\+\_\+kem\+\_\+enc(ephemeral\+\_\+pub\+\_\+key, ss, v\+\_\+pub)} to generate shared secret {\ttfamily ss} and ephemeral public key.
\item Prints sender\textquotesingle{}s public key and derived shared secret.
\item Calls \doxylink{protocol__api_8h_a2a804d61df9a40fc309e6c609739110d}{calculate\+\_\+stealth\+\_\+pub\+\_\+key()} to compute stealth public key using public key {\ttfamily k\+\_\+pub} and shared secret {\ttfamily ss}. The resulting stealth public key is written into the output parameter {\ttfamily stealth\+\_\+pub\+\_\+key}.
\item Calls \doxylink{protocol__api_8h_a9a43976b56c90c6d13ef53bda55a3d34}{calculate\+\_\+view\+\_\+tag()} to compute view tag from shared secret {\ttfamily ss}.
\end{DoxyEnumerate}


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em stealth\+\_\+pub\+\_\+key} & Output array for computed stealth public key. \\
\hline
\mbox{\texttt{ out}}  & {\em ephemeral\+\_\+pub\+\_\+key} & Output ephemeral public key (to be sent to recipient). \\
\hline
\mbox{\texttt{ out}}  & {\em view\+\_\+tag} & Output computed view tag (single byte). \\
\hline
\mbox{\texttt{ in}}  & {\em v\+\_\+pub} & Recipient\textquotesingle{}s public "{}view"{} key. \\
\hline
\mbox{\texttt{ in}}  & {\em k\+\_\+pub} & Recipient\textquotesingle{}s public "{}spending"{} key. \\
\hline
\end{DoxyParams}
